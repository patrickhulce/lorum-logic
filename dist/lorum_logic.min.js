angular.module("lorum.logic.controllers.games.detail",[]).controller("GameDetailCtrl",["$scope","$stateParams","$state","GamesService",function(a,b,c,d){a.game=null,a.ui={isLoading:!1},a.reload=function(){a.ui.isLoading=!0,d.fetchById(b.gameId).success(function(b){a.game=b,a.gameData=b.serialize(),a.ui.isLoading=!1}).error(function(a){c.go("games.all")})},a.reload(),a.$on("$ionicView.enter",a.reload)}]),angular.module("lorum.logic.controllers.games.list",[]).controller("GameListCtrl",["$scope","GamesService",function(a,b){a.games=[],a.isLoading=!1,a.reload=function(){a.isLoading=!0,b.fetchAll().success(function(b){a.isLoading=!1,a.games=b})},a.reload(),a.$on("$ionicView.enter",a.reload)}]),angular.module("lorum.logic.controllers.games.new",[]).controller("GameNewCtrl",["$scope","$state","GamesService","UsersService",function(a,b,c,d){a.name="",a.playerIds=[],a.isRanked=!0,a.availableUsers=[],d.fetchAll().success(function(b){a.availableUsers=b}),a.$watch("playerIds",function(){var b=a.playerIds.map(function(b){return _.find(a.availableUsers,{id:b}).firstName});0===b.length&&(b=["?"]),a.name="Game with "+b.join(", ")},!0),a.isSaveable=function(){return 4===_.uniq(a.playerIds).length&&a.playerIds.reduce(function(a,b){return a&&b})},a.save=function(){c.create(a.name,a.playerIds,!a.isRanked).success(function(a){b.go("tab.games-detail",{gameId:a.id})})}}]),angular.module("lorum.logic.controllers.games.scores",[]).controller("GameScoresCtrl",["$scope","GamesService","LorumLogic",function(a,b,c){var d=function(a,b){return b||(b=0),_(a).indexBy("id").mapValues(function(){return b}).value()};a.gameNames=c.GameTypeNames,a.individualScores=[],a.totalScores=[];var e={activeRound:1,activeGameType:1,isMoonShotUIActive:!1},f={nextScores:d([]),selectedUser:-1};a.uiState=e,a.uiFormData=f,a.isFinished=function(){return!(a.game&&a.game.getCurrentHandMetadata())},a.isUpdate=function(){var b=a.game&&a.game.getCurrentHandMetadata();return b?e.activeRound!==b.round||e.activeGameType!==b.gameType:!0},a.isValidScore=function(){var a=_.values(f.nextScores);return c.isValidScore(e.activeGameType,a)},a.canBomb=function(){return c.isBomb(e.activeGameType)},a.canShootMoon=function(){return c.canShootMoon(e.activeGameType)},a.setScore=function(a,b){f.nextScores[a]=b},a.scoreFor=function(b,c){return c||(c=a.game&&a.game.getLastCompletedHandMetadata()),c?a.totalScores[c.round-1][c.gameType-1][b]:"-"},a.selectUser=function(b){var c=a.canShootMoon()?10:0,e=d(a.game.getActivePlayers(),c);e[b]=10-c,f.selectedUser=b,f.nextScores=e},a.selectHand=function(b,d){e.activeRound=b,e.activeGameType=d,e.isMoonShotUIActive=!1;var g=a.individualScores[b-1][d-1];f.nextScores=g,f.selectedUser=-1,c.isBomb(d)?f.selectedUser=_.findKey(g,function(a){return 10===a}):30===_.sum(g)&&(e.isMoonShotUIActive=!0,f.selectedUser=_.findKey(g,function(a){return 0===a})),a.setView&&a.setView("record")},a.submitScore=function(){var c=a.isUpdate()?b.updateScore:b.recordScore;a.ui.isLoading=!0,c({round:e.activeRound,gameType:e.activeGameType,gameId:a.game.id,scores:f.nextScores}).success(function(){a.reload()})},a.resetUIState=function(){var b=a.game.getCurrentHandMetadata()||{};e.activeGameType=b.gameType,e.activeRound=b.round,e.isMoonShotUIActive=!1,f.selectedUser=-1,f.nextScores=d(a.game.getActivePlayers())},a.$watch("game",function(b){b&&b.hands&&(a.resetUIState(),a.individualScores=b.getIndividualScoresMatrix(),a.totalScores=b.getRunningTotalScoresMatrix(),a.ui.isLoading=!1)},!0)}]),angular.module("lorum.logic.helpers.logic",[]).factory("LorumLogic",function(){var a={HEARTS:1,UPPERS:2,EACH:3,LAST:4,RED_KING:5,BABY_BLUE:6,QUARTET:7,SEVENUP:8},b=[null,"Piros Fogas","Felso Fogas","Utes Fogas","Utolsho","Piros Kiraly","Muck Also","Kvartett","Laracos"],c=function(a,b){return a&&b?8*(a-1)+b:0};return{GameTypes:a,GameTypeNames:b,isValidScore:function(b,c){var d=4===c.length&&_.every(c,function(a){return"number"==typeof a});if(!d)return!1;var e=_.sum(c),f=function(a){return _.contains(c,a)};switch(b){case a.HEARTS:case a.EACH:return 8===e||30===e&&f(0);case a.UPPERS:return 10===e||30===e&&f(0);case a.LAST:case a.RED_KING:case a.BABY_BLUE:return 10===e&&f(10);case a.QUARTET:case a.SEVENUP:return f(0)&&!f(9)&&!f(10)&&!_.every(c,function(a){return 0===a})}},isBomb:function(b){return _.contains([a.LAST,a.RED_KING,a.BABY_BLUE],b)},canShootMoon:function(b){return _.contains([a.HEARTS,a.UPPERS,a.EACH],b)},handsCompleted:c,percentComplete:function(a,b){return c(a,b)/32*100}}}),angular.module("lorum.logic",["lorum.logic.controllers.games.detail","lorum.logic.controllers.games.list","lorum.logic.controllers.games.new","lorum.logic.controllers.games.scores","lorum.logic.helpers.logic","lorum.logic.models.game","lorum.logic.services.games","lorum.logic.services.users"]),angular.module("lorum.logic.models.game",[]).factory("GameModel",function(){var a=function(a){if(!a)return{round:1,gameType:1};if(8===a.gameType){if(4===a.round)return;return{round:a.round+1,gameType:1}}return{round:a.round,gameType:a.gameType+1}},b=function(a){if(a){if(1===a.gameType){if(1===a.round)return;return{round:a.round-1,gameType:8}}return{round:a.round,gameType:a.gameType-1}}};return{fromJson:function(c){var d=_.extend({},c);return _.extend(c||{},{getActivePlayers:function(){return this.players?_(this.players).filter(function(a){return a.userGames.isActive}).sortBy(function(a){return a.userGames.position}).value():[]},getIndividualScoresMatrix:function(){return _(this.hands||[]).groupBy("round").values().map(function(a){return _(a).groupBy("gameType").values().map(function(a){return _(a).indexBy("scorerId").mapValues("score").value()}).value()}).value()},getRunningTotalScoresMatrix:function(){var a=this.getActivePlayers(),b=[],c=[];return this.getIndividualScoresMatrix().forEach(function(d,e){d.forEach(function(d,f){c[e]||(c[e]=[]),a.forEach(function(a){b[a.id]=(b[a.id]||0)+d[a.id]}),c[e][f]=_.assign({},b)})}),c},getLastCompletedHandMetadata:function(){if(this.hands&&this.hands.length){var a=_.max(this.hands,function(a){return 10*a.round+a.gameType});return{round:a.round,gameType:a.gameType}}},getCurrentHandMetadata:function(){return a(this.getLastCompletedHandMetadata())},findHand:function(a,b,c){var d=_.where,e={round:a,gameType:b};return c&&(e.scorerId=c,d=_.find),d(this.hands||[],e)},findPreviousHand:function(a,c,d){var e=b({round:a,gameType:c});return findHand(e.round,e.gameType,d)},serialize:function(){return _.extend({},d,{activePlayers:this.getActivePlayers(),lastCompletedHandMeta:this.getLastCompletedHandMetadata(),currentHandMeta:this.getCurrentHandMetadata()})}})}}}),angular.module("lorum.logic.services.games",[]).provider("GamesService",function(){this.baseUrl="",this.setUrl=function(a){this.baseUrl=a.trim().replace(/\/$/,"")},this.$get=["$http","GameModel",function(a,b){var c=this.baseUrl;return{fetchAll:function(){return a.get(c+"/games").success(function(a){return a.map(b.fromJson)})},fetchById:function(d){return a.get(c+"/games/"+d).success(function(a){return b.fromJson(a)})},create:function(d,e,f){return a.post(c+"/games",{name:d,playerIds:e,doNotTrack:f}).success(function(a){return b.fromJson(a)})},update:function(b,d,e){return a.put(c+"/games/"+b,{name:d,playerIds:e})},recordScore:function(b){return a.post(c+"/games/"+b.gameId+"/hands",b)},updateScore:function(b){return a.put(c+"/games/"+b.gameId+"/hands",b)}}}]}),angular.module("lorum.logic.services.users",[]).provider("UsersService",function(){this.baseUrl="",this.setUrl=function(a){this.baseUrl=a.trim().replace(/\/$/,"")},this.$get=["$http",function(a){var b=this.baseUrl;return{fetchAll:function(){return a.get(b+"/users").success(function(a){return a.data})}}}]});