angular.module("lorum.logic.config",[]).provider("LorumConfig",function(){this.views={},this.hooks=[],this.addView=function(a,b){this.views[a]=b},this.addHook=function(a,b){this.hooks.push({controller:a,hook:b})},this.$get=function(){var a=this.views,b=this.hooks;return{getView:function(b){return a[b]||b},hooks:function(a,c){b.filter(function(b){return a===b.controller}).forEach(function(a){a.hook(c)})}}}}),angular.module("lorum.logic.controllers.games.detail",[]).controller("GameDetailCtrl",["$scope","$stateParams","$state","LorumConfig","GamesService",function(a,b,c,d,e){a.game=null,a.gameData=null,a.ui={isLoading:!1},a.reload=function(){a.ui.isLoading=!0,e.fetchById(b.gameId).success(function(b){a.game=b,a.ui.isLoading=!1}).error(function(a){c.go(d.getView("games.all"))})},a.$watch("game",function(b){b&&(a.gameData=b.serialize())},!0),a.reload(),d.hooks("GameDetailCtrl",a)}]),angular.module("lorum.logic.controllers.games.edit",[]).controller("GameEditCtrl",["$scope","$state","LorumConfig","GamesService","UsersService",function(a,b,c,d,e){var f=!b.params.gameId;a.isNew=f,a.name="",a.playerIds=[],a.isRanked=!0,a._game={},a.ui={isLoading:!f},a.availableUsers=[],e.fetchAll().success(function(b){a.availableUsers=b}),a.$watch("playerIds",function(){var b=a.playerIds.map(function(b){return _.find(a.availableUsers,{id:b}).firstName});0===b.length&&(b=["?"]),a.name="Game with "+b.join(", ")},!0),a.isSaveable=function(){return 4===_.uniq(a.playerIds).length&&a.playerIds.reduce(function(a,b){return a&&b})},a.save=function(){var e=f?d.create(a.name,a.playerIds,!a.isRanked):d.update(a._game.id,a.name,a.playerIds);e.success(function(d){b.go(c.getView("games.detail"),{gameId:a._game.id||d.id})})},f||d.fetchById(b.params.gameId).success(function(b){a.name=b.name,a.playerIds=_(b.players).filter("userGames.isActive").sortBy("userGames.position").pluck("id").value(),a._game=b,a.ui.isLoading=!1}).error(function(a){b.go(c.getView("games.all"))}),c.hooks("GameEditCtrl",a)}]),angular.module("lorum.logic.controllers.games.list",[]).controller("GameListCtrl",["$scope","LorumConfig","GamesService",function(a,b,c){a.games=[],a.isLoading=!1,a.reload=function(){a.isLoading=!0,c.fetchAll().success(function(b){a.isLoading=!1,a.games=b})},a.reload(),b.hooks("GameListCtrl",a)}]),angular.module("lorum.logic.controllers.games.scores",[]).controller("GameScoresCtrl",["$scope","LorumConfig","GamesService","LorumLogic",function(a,b,c,d){var e=function(a,b){return b||(b=0),_(a).indexBy("id").mapValues(function(){return b}).value()};a.gameNames=d.GameTypeNames;var f={activeRound:1,activeGameType:1,isMoonShotUIActive:!1},g={nextScores:e([]),selectedUser:-1};a.uiState=f,a.uiFormData=g,a.isFinished=function(){return!(a.game&&a.game.getCurrentHandMetadata())},a.isUpdate=function(){var b=a.game&&a.game.getCurrentHandMetadata();return b?f.activeRound!==b.round||f.activeGameType!==b.gameType:!0},a.isValidScore=function(){var a=_.values(g.nextScores);return d.isValidScore(f.activeGameType,a)},a.canBomb=function(){return d.isBomb(f.activeGameType)},a.canShootMoon=function(){return d.canShootMoon(f.activeGameType)},a.setScore=function(a,b){g.nextScores[a]=b},a.scoreFor=function(b,c){return c||(c=a.game&&a.game.getLastCompletedHandMetadata()),c&&a.gameData?a.gameData.totalScoresMatrix[c.round-1][c.gameType-1][b]:"-"},a.selectUser=function(b){var c=a.canShootMoon()?10:0,d=e(a.game.getActivePlayers(),c);d[b]=10-c,g.selectedUser=b,g.nextScores=d},a.selectHand=function(b,c){f.activeRound=b,f.activeGameType=c,f.isMoonShotUIActive=!1;var e=a.gameData.individualScoresMatrix[b-1][c-1];g.nextScores=e,g.selectedUser=-1,d.isBomb(c)?g.selectedUser=_.findKey(e,function(a){return 10===a}):30===_.sum(e)&&(f.isMoonShotUIActive=!0,g.selectedUser=_.findKey(e,function(a){return 0===a}))},a.submitScore=function(){var b=a.isUpdate()?c.updateScore:c.recordScore;a.ui.isLoading=!0,b({round:f.activeRound,gameType:f.activeGameType,gameId:a.game.id,scores:g.nextScores}).success(function(){a.reload()})},a.resetUIState=function(){var b=a.game.getCurrentHandMetadata()||{};f.activeGameType=b.gameType,f.activeRound=b.round,f.isMoonShotUIActive=!1,g.selectedUser=-1,g.nextScores=e(a.game.getActivePlayers())},a.$watch("game",function(b){b&&b.hands&&(a.resetUIState(),a.ui.isLoading=!1)},!0),b.hooks("GameScoresCtrl",a)}]),angular.module("lorum.logic.controllers.settings",[]).controller("SettingsCtrl",["$scope","LorumConfig",function(a,b){a.games=[],a.isLoading=!1,b.hooks("SettingsCtrl",a)}]),angular.module("lorum.logic.helpers.logic",[]).factory("LorumLogic",function(){var a={HEARTS:1,UPPERS:2,EACH:3,LAST:4,RED_KING:5,BABY_BLUE:6,QUARTET:7,SEVENUP:8},b=[null,"Piros Fogas","Felso Fogas","Utes Fogas","Utolsho","Piros Kiraly","Muck Also","Kvartett","Laracos"],c=function(a,b){return a&&b?8*(a-1)+b:0};return{GameTypes:a,GameTypeNames:b,isValidScore:function(b,c){var d=4===c.length&&_.every(c,function(a){return"number"==typeof a});if(!d)return!1;var e=_.sum(c),f=function(a){return _.contains(c,a)};switch(b){case a.HEARTS:case a.EACH:return 8===e||30===e&&f(0);case a.UPPERS:return 10===e||30===e&&f(0);case a.LAST:case a.RED_KING:case a.BABY_BLUE:return 10===e&&f(10);case a.QUARTET:case a.SEVENUP:return f(0)&&!f(9)&&!f(10)&&!_.every(c,function(a){return 0===a})}},isBomb:function(b){return _.contains([a.LAST,a.RED_KING,a.BABY_BLUE],b)},canShootMoon:function(b){return _.contains([a.HEARTS,a.UPPERS,a.EACH],b)},handsCompleted:c,percentComplete:function(a,b){return c(a,b)/32*100}}}),angular.module("lorum.logic",["lorum.logic.config","lorum.logic.controllers.games.detail","lorum.logic.controllers.games.list","lorum.logic.controllers.games.edit","lorum.logic.controllers.games.scores","lorum.logic.controllers.settings","lorum.logic.helpers.logic","lorum.logic.models.game","lorum.logic.services.games","lorum.logic.services.users"]),angular.module("lorum.logic.models.game",[]).factory("GameModel",function(){var a=function(a){if(!a)return{round:1,gameType:1};if(8===a.gameType){if(4===a.round)return;return{round:a.round+1,gameType:1}}return{round:a.round,gameType:a.gameType+1}},b=function(a){if(a){if(1===a.gameType){if(1===a.round)return;return{round:a.round-1,gameType:8}}return{round:a.round,gameType:a.gameType-1}}};return{fromJson:function(c){var d=_.extend({},c);return _.extend(c||{},{getActivePlayers:function(){return this.players?_(this.players).filter(function(a){return a.userGames.isActive}).sortBy(function(a){return a.userGames.position}).value():[]},_getHandsMatrix:function(){return _(this.hands||[]).groupBy("round").values().map(function(a){return _(a).groupBy("gameType").values().value()}).value()},_mutateHands:function(a){return _.map(this._getHandsMatrix(),function(b){return _.map(b,a)})},getActivePlayersMatrix:function(){var a=_(this.players).indexBy("id").mapValues("userGames.position").value();return this._mutateHands(function(b){return _(b).sortBy(function(b){return a[b.scorerId]}).pluck("scorerId").value()})},getIndividualScoresMatrix:function(){return this._mutateHands(function(a){return _(a).indexBy("scorerId").mapValues("score").value()})},getRunningTotalScoresMatrix:function(){var a=this.getActivePlayersMatrix(),b=[0,0,0,0],c=[];return this.getIndividualScoresMatrix().forEach(function(d,e){d.forEach(function(d,f){c[e]||(c[e]=[]);var g={};a[e][f].forEach(function(a,c){var e=b[c]+d[a];b[c]=e,g[a]=e}),c[e][f]=g})}),c},getLastCompletedHandMetadata:function(){if(this.hands&&this.hands.length){var a=_.max(this.hands,function(a){return 10*a.round+a.gameType});return{round:a.round,gameType:a.gameType}}},getCurrentHandMetadata:function(){return a(this.getLastCompletedHandMetadata())},findHand:function(a,b,c){var d=_.where,e={round:a,gameType:b};return c&&(e.scorerId=c,d=_.find),d(this.hands||[],e)},findPreviousHand:function(a,c,d){var e=b({round:a,gameType:c});return findHand(e.round,e.gameType,d)},serialize:function(){return _.extend({},d,{activePlayers:this.getActivePlayers(),lastCompletedHandMeta:this.getLastCompletedHandMetadata(),currentHandMeta:this.getCurrentHandMetadata(),individualScoresMatrix:this.getIndividualScoresMatrix(),totalScoresMatrix:this.getRunningTotalScoresMatrix(),activePlayersMatrix:this.getActivePlayersMatrix()})}})}}}),angular.module("lorum.logic.services.games",[]).provider("GamesService",function(){this.baseUrl="",this.setUrl=function(a){this.baseUrl=a.trim().replace(/\/$/,"")},this.$get=["$http","GameModel",function(a,b){var c=this.baseUrl;return{fetchAll:function(){return a.get(c+"/games").success(function(a){return a.map(b.fromJson)})},fetchById:function(d){return a.get(c+"/games/"+d).success(function(a){return b.fromJson(a)})},create:function(d,e,f){return a.post(c+"/games",{name:d,playerIds:e,doNotTrack:f}).success(function(a){return b.fromJson(a)})},update:function(b,d,e){return a.put(c+"/games/"+b,{name:d,playerIds:e})},recordScore:function(b){return a.post(c+"/games/"+b.gameId+"/hands",b)},updateScore:function(b){return a.put(c+"/games/"+b.gameId+"/hands",b)}}}]}),angular.module("lorum.logic.services.users",[]).provider("UsersService",function(){this.baseUrl="",this.setUrl=function(a){this.baseUrl=a.trim().replace(/\/$/,"")},this.$get=["$http",function(a){var b=this.baseUrl;return{fetchAll:function(){return a.get(b+"/users").success(function(a){return a.data})}}}]});